<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Health Rating Calculator - AaronMiscellaneous</title>
        <style>
            body {
                font-family: Consolas, monospace;
                background: #1d2227;
                color: #e8e8e8;
                margin: 0;
                padding: 15px;
                line-height: 1.2;
            }

            a {
                color: #3391ff;
            }

            h1, h2, h3 {
                font-weight: 600;
                color: #e8e8e8;
            }         

            table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 10px;
            }
            
            th, td {
                padding: 8px;
                background: #181a1b;
                border-bottom: 1px solid #5e6162;
                width: 10px;
            }
            
            th {
                background: #212325;
                font-weight: bold;
                text-align: left;
            }
            
            input[type="number"] {
                width: 80px;
                padding: 5px;
                border: 1px solid #bbb;
                background-color: #212325;
                color: #e8e8e8;
                border-radius: 4px;
                font-family: Consolas, monospace;
            }
            
            div.container {
                border: 2px solid;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                background: #181a1b;
                border-color: #304d72;
                position: relative;
            }

            div.container-title {
                position: absolute;
                top: -12px;
                left: 10px;
                
                background: #27456a;
                padding: 3px 10px;
                font-weight: bold;
                color: white;
                border-radius: 5px;
            }
            
            div.container.risk {border-color: #de763a}
            div.container-title.risk {background: #e3661e}
            div.container.benefit {border-color: #307231}
            div.container-title.benefit {background: #1b963c}
            
            /* Results styling */
            #resultsBox {
                padding: 15px;
                border-radius: 10px;
                width: fit-content;
                box-shadow: 0 3px 8px rgba(0,0,0,0.08);
                transition: background 0.4s, border-color 0.4s;
                font-size: 1.2em;
                border-style: double;
            }

            /* Colour-coding for ratings */
            #resultsBox.rating-none  { background: #2c2c2c; border: #9b9b9b; }
            #resultsBox.rating-verypoor  { background: #8a0404;}
            #resultsBox.rating-poor      { background: #b25d07;}
            #resultsBox.rating-average   { background: #a09005;}
            #resultsBox.rating-good      { background: #379607;}
            #resultsBox.rating-excellent { background: #088fa0;}
        </style>
    </head>
    <body>
        <h1>Health Rating Calculator</h1>
        <h2>Inputs&nbsp;</h2>
        <div oninput="update()">
            <div class="container risk">
                <div class="container-title risk">Risk Points</div>
                <table>
                    <tbody>
                        <tr>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Amount</th>
                            <th>Points</th>
                        </tr>
                        <tr>
                            <td>Energy</td>
                            <td>kJ</td>
                            <td><input id="energyInput" type="number" step="any"></td>
                            <td id="energyPoints">0</td>
                        </tr>
                        <tr>
                            <td>Saturated Fat</td>
                            <td>g</td>
                            <td><input id="saturatedFatInput" type="number" step="any"></td>
                            <td id="saturatedFatPoints">0</td>
                        </tr>
                        <tr>
                            <td>Sugar</td>
                            <td>g</td>
                            <td><input id="sugarInput" type="number" step="any"></td>
                            <td id="sugarPoints">0</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>mg</td>
                            <td><input id="sodiumInput" type="number" step="any"></td>
                            <td id="sodiumPoints">0</td>
                        </tr>
                    </tbody>
                </table>
                <p>Total Risk Points: <span id="totalRiskPoints">0</span></p>
            </div>
            <div class="container benefit">
                <div class="container-title benefit">Benefit Points</div>
                <table>
                    <tbody>
                        <tr>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Amount</th>
                            <th>Points</th>
                        </tr>
                        <tr>
                            <td>Concentrated Fruits and Veg</td>
                            <td>%</td>
                            <td><input id="concentratedFvInput" type="number" step="any"></td>
                            <td id="concentratedFvPoints">0</td>
                        </tr>
                        <tr>
                            <td>Natural Fruits and Veg</td>
                            <td>%</td>
                            <td><input id="naturalFvInput" type="number" step="any"></td>
                            <td id="naturalFvPoints">0</td>
                        </tr>
                        <tr>
                            <td>Protein</td>
                            <td>g</td>
                            <td><input id="proteinInput" type="number" step="any"></td>
                            <td id="proteinPoints">0</td>
                        </tr>
                        <tr>
                            <td>Dietary Fibre</td>
                            <td>g</td>
                            <td><input id="dietaryFibreInput" type="number" step="any"></td>
                            <td id="dietaryFibrePoints">0</td>
                        </tr>
                    </tbody>
                </table>
                <p>Total Benefit Points: <span id="totalBenefitPoints">0</span></p>
            </div>
        </div>
        <h2>Results</h2>

        <div id="resultsBox">
            <p>Final score: <span id="finalScoreText">0</span></p>
            <p>Normalized score: <span id="normalizedScoreText">0</span>/100</p>
            <p>Rating meaning: <span id="ratingMeaningText">None</span></p>
        </div>

        <div>
            <h2>About</h2>
            <div class="container">
                <div class="container-title">Credits</div>
                <p><strong>Made by</strong>: AaronMiscellaneous</p>
            </div>

            <div class="container">
                <div class="container-title">Project</div>
                <p>This webpage was made to easily rate how healthy a food is.</p>
                <p>The rating takes input of nutritional values of a food and outputs a rating of how healthy it is from 0 to 100.</p>
                <p>This is a rough and does not take into account additives or every single type of food (see below).</p>
            </div>

            <div class="container">
                <div class="container-title">Supported Foods</div>
                <p>This calculator mainly focuses on foods.</p>
                <ul>
                    <li>Non-dairy (not milk, butter, etc).</li>
                    <li>Not drinks.</li>
                </ul>
            </div>

            <div class="container">
                <div class="container-title">Inputs</div>
                <p>For everything, input as per 100g.</p>
                <p><strong>Concentrated fruits and veg</strong>: Includes fruits and vegetables that have been dried, having their moisture decreased, or concentrated.</p>
                <p><strong>Natural fruits and veg</strong>: Includes fruits and vegetables that are fresh, have been cooked or pureed (ground, pressed, blended or sieved).</p>
            </div>

            <div class="container">
                <div class="container-title">Understanding Results</div>
                <p><strong>Points</strong>: Risk points are bad, making the food count as unhealthier. Benefit points are good, making the food count as healthier.</p>
                <p><strong>Final score</strong>: Benefit points - risk points. -25 is bad and 10 is good</p>
                <p><strong>Normalized rating</strong>: The normalized rating is the final rating normalized so -25 is 0 and 10 is 100, placing it on a scale. It can go above or below, to show really healthy or really unhealthy foods.</p>
            </div>
        </div>
    <script>
        const riskNutrientConfig = {
            energy: {
                amount: () => getFloatFromId("energyInput"),
                method: "linear",
                gradient: 335,
                maxPoints: 11,
                outputId: "energyPoints",
                max: 5000,
            },
            saturatedFat: {
                amount: () => getFloatFromId("saturatedFatInput"),
                method: "list",
                list: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11.2, 12.5, 13.9, 15.5, 17.3, 19.3, 21.6, 24.1, 26.9, 30, 33.5, 37.4, 41.7, 46.6, 52, 58, 64.7, 72.3, 80.6, 90],
                outputId: "saturatedFatPoints",
                max: 100
            },
            sugar: {
                amount: () => getFloatFromId("sugarInput"),
                method: "linear",
                gradient: 3.808,
                maxPoints: 25,
                outputId: "sugarPoints",
                max: 100
            },
            sodium: {
                amount: () => getFloatFromId("sodiumInput"),
                method: "linear",
                gradient: 90,
                maxPoints: 30,
                outputId: "sodiumPoints",
                max: 100000
            },
        };

        const modifierNutrientConfig = {
            concentratedFv: {
                amount: () => getFloatFromId("concentratedFvInput"),
                method: "list",
                list: [0, 25, 43, 52, 63, 67, 80, 90, 99.5],
                outputId: "concentratedFvPoints",
                max: 100
            },
            naturalFv: {
                amount: () => getFloatFromId("naturalFvInput"),
                method: "list",
                list: [0, 40, 60, 67, 75, 80, 90, 95, 99.5],
                outputId: "naturalFvPoints",
                max: 100
            },
            protein: {
                amount: () => getFloatFromId("proteinInput"),
                method: "list",
                list: [0, 1.6, 3.2, 4.8, 6.4, 8, 9.6, 11.6, 13.9, 16.7, 20, 24, 28.9, 34.7, 41.6, 50],
                outputId: "proteinPoints",
                max: 100
            },
            dietaryFibre: {
                amount: () => getFloatFromId("dietaryFibreInput"),
                list: [0, .9, 1.9, 2.8, 3.7, 4.7, 5.4, 6.3, 7.3, 8.4, 9.7, 11.2, 13, 15, 17.3, 20],
                method: "list",
                outputId: "dietaryFibrePoints",
                max: 100
            },
        };

        const ratingMeanings = { // If the normalised score is less than the key, it means the value
            100: "Excellent",
            80: "Good",
            60: "Average",
            40: "Poor",
            20: "Very poor",
        }

        let totalRiskPoints = 0;
        let totalBenefitPoints = 0;

        let finalScore = 0;
        let normalizedScore = 0;
        let ratingMeaning = "";

        function roundToPlace(value, place=2) {
            return Math.round(value * Math.pow(10, place)) / Math.pow(10, place);
        }

        function normalize(value, min, max, multiplier=1) {
            return (value - min) / (max - min) * multiplier;
        }

        function getFloatFromId(id) {
            /**
             * Returns the value of the input field with the given id as a float.
             * @param {string} id - The id of the element.
             * @returns {number} - The value of the element with that id.
             */
            const raw = document.getElementById(id).value;
            const num = parseFloat(raw);
            return isNaN(num) ? 0 : num;
        }

        function setMaxValueOfId(id, value, maximum) {
            document.getElementById(id).value = Math.min(value, maximum);
        }

        function convertRatingMeaningNameToClass(name) {
            name = name.toLowerCase();
            name = name.replace(" ", "");
            return "rating-" + name;
        }

        function calculatePoints(singleNutrientConfig) {
            /**
             * Returns the number of points given the amount of the nutrient.
             * @param {object} singleNutrientConfig - The config for the nutrient.
             * @returns {number} - The number of points for the nutrient.
             */
            let amount = singleNutrientConfig.amount();
            if (singleNutrientConfig.method === "linear") {
                let points =  amount / singleNutrientConfig.gradient;
                points = Math.min(points, singleNutrientConfig.maxPoints);
                points = Math.max(points, 0);
                return points;
            }
            else if (singleNutrientConfig.method === "list") {
                let list = singleNutrientConfig.list;
                for (let i = list.length - 1; i >= 0; i--) {
                    if (amount > list[i]) {
                        if (!(i === list.length - 1)) {
                            small_value = list[i];
                            large_value = list[i + 1];
                            points = (amount - small_value) / (large_value - small_value) + i;
                            return points;
                        }
                        return i;
                    }
                }
                return 0; 
            }
        }
        
        function updatePoints(nutrientCollectionConfig) {
            let totalPoints = 0;

            for (const key in nutrientCollectionConfig) { // Loops through every nutrient
                const singleNutrientConfig = nutrientCollectionConfig[key]; // Gets the specific nutrient config

                let amount = singleNutrientConfig.amount(); // Gets the amount of the nutrient inputted
                amount = Math.min(amount, singleNutrientConfig.max);

                let points = calculatePoints(singleNutrientConfig); // Calculates the points
                totalPoints += points;

                document.getElementById(singleNutrientConfig.outputId).innerHTML = roundToPlace(points); // Updates the output element to the points
            }
            return totalPoints;
        }

        function updateRiskPoints() {
            totalRiskPoints = updatePoints(riskNutrientConfig);
            document.getElementById("totalRiskPoints").innerHTML = roundToPlace(totalRiskPoints);
        }

        function updateModifierPoints() {
            totalBenefitPoints = updatePoints(modifierNutrientConfig);
            document.getElementById("totalBenefitPoints").innerHTML = roundToPlace(totalBenefitPoints);
        }

        function getRatingMeaning(normalizedScore) {
            if (normalizedScore > 80) return ratingMeanings[100];
            for (const key in ratingMeanings) {
                if (normalizedScore <= key) {
                    return ratingMeanings[key];
                }
            }
        }

        function calculateResults() {
            finalScore = totalBenefitPoints - totalRiskPoints;
            normalizedScore = normalize(finalScore, -25, 10, 100);
            ratingMeaning = getRatingMeaning(normalizedScore);
        }

        function updateResults() {
            document.getElementById("finalScoreText").innerHTML = roundToPlace(finalScore);
            document.getElementById("normalizedScoreText").innerHTML = roundToPlace(normalizedScore, 0);
            document.getElementById("ratingMeaningText").innerHTML = ratingMeaning;
        }


        function updateResultsVisual() {
            const box = document.getElementById("resultsBox");
            box.classList.remove(
                "rating-verypoor",
                "rating-poor",
                "rating-average",
                "rating-good",
                "rating-excellent"
            );

            box.classList.add(convertRatingMeaningNameToClass(ratingMeaning));
        }        
        
        function update() {
            updateRiskPoints();
            updateModifierPoints();
            calculateResults();
            updateResults();
            updateResultsVisual();
        }

        window.onload = update;
    </script>
    </body>
</html>