<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Health Rating Calculator - AaronMiscellaneous</title>
        <style>
            body {
                font-family: Consolas, monospace;
                background: #1d2227;
                color: #e8e8e8;
                margin: 0;
                padding: 15px;
                line-height: 1.2;
            }

            a {
                color: #3391ff;
            }

            h1, h2, h3 {
                font-weight: 600;
                color: #e8e8e8;
            }         

            table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 10px;
            }
            
            th, td {
                padding: 8px;
                background: #181a1b;
                border-bottom: 1px solid #5e6162;
                width: 10px;
            }
            
            th {
                background: #212325;
                font-weight: bold;
                text-align: left;
            }
            
            input[type="number"] {
                width: 80px;
                padding: 5px;
                border: 1px solid #bbb;
                background-color: #212325;
                color: #e8e8e8;
                border-radius: 4px;
                font-family: Consolas, monospace;
            }
            
            div.container {
                border: 2px solid;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                background: #181a1b;
                border-color: #304d72;
                position: relative;
            }

            div.container-title {
                position: absolute;
                top: -12px;
                left: 10px;
                
                background: #27456a;
                padding: 3px 10px;
                font-weight: bold;
                color: white;
                border-radius: 5px;
            }
            
            div.container.baseline {border-color: #de763a}
            div.container-title.baseline {background: #e3661e}
            div.container.modifying {border-color: #307231}
            div.container-title.modifying {background: #1b963c}
            
            /* Results styling */
            #resultsBox {
                padding: 15px;
                border-radius: 10px;
                width: fit-content;
                box-shadow: 0 3px 8px rgba(0,0,0,0.08);
                transition: background 0.4s, border-color 0.4s;
                font-size: 1.2em;
                border-style: double;
            }

            /* Colour-coding for ratings */
            #resultsBox.rating-none  { background: #2c2c2c; border: #9b9b9b; }
            #resultsBox.rating-verypoor  { background: #8a0404;}
            #resultsBox.rating-poor      { background: #b25d07;}
            #resultsBox.rating-average   { background: #a09005;}
            #resultsBox.rating-good      { background: #379607;}
            #resultsBox.rating-excellent { background: #088fa0;}
        </style>
    </head>
    <body>
        <h1>Health Rating Calculator</h1>
        <h2>Inputs&nbsp;</h2>
        <div oninput="update()">
            <div class="container baseline">
                <div class="container-title baseline">Baseline Points</div>
                <table>
                    <tbody>
                        <tr>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Amount</th>
                            <th>Points</th>
                        </tr>
                        <tr>
                            <td>Energy</td>
                            <td>kJ</td>
                            <td><input id="energyInput" type="number" step="any"></td>
                            <td id="energyPoints">0</td>
                        </tr>
                        <tr>
                            <td>Saturated Fat</td>
                            <td>g</td>
                            <td><input id="saturatedFatInput" type="number" step="any"></td>
                            <td id="saturatedFatPoints">0</td>
                        </tr>
                        <tr>
                            <td>Sugar</td>
                            <td>g</td>
                            <td><input id="sugarInput" type="number" step="any"></td>
                            <td id="sugarPoints">0</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>mg</td>
                            <td><input id="sodiumInput" type="number" step="any"></td>
                            <td id="sodiumPoints">0</td>
                        </tr>
                    </tbody>
                </table>
                <p>Total Baseline Points: <span id="totalBaselinePoints">0</span></p>
            </div>
            <div class="container modifying">
                <div class="container-title modifying">Modifying Points</div>
                <table>
                    <tbody>
                        <tr>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Amount</th>
                            <th>Points</th>
                        </tr>
                        <tr>
                            <td>Concentrated FNVL</td>
                            <td>%</td>
                            <td><input id="concentratedFnvlInput" type="number" step="any"></td>
                            <td id="concentratedFnvlPoints">0</td>
                        </tr>
                        <tr>
                            <td>Non-Concentrated FNVL</td>
                            <td>%</td>
                            <td><input id="nonConcentratedFnvlInput" type="number" step="any"></td>
                            <td id="nonConcentratedFnvlPoints">0</td>
                        </tr>
                        <tr>
                            <td>Protein</td>
                            <td>g</td>
                            <td><input id="proteinInput" type="number" step="any"></td>
                            <td id="proteinPoints">0</td>
                        </tr>
                        <tr>
                            <td>Dietary Fibre</td>
                            <td>g</td>
                            <td><input id="dietaryFibreInput" type="number" step="any"></td>
                            <td id="dietaryFibrePoints">0</td>
                        </tr>
                    </tbody>
                </table>
                <p>Total Modifying Points: <span id="totalModifyingPoints">0</span></p>
            </div>
        </div>
        <h2>Results</h2>

        <div id="resultsBox">
            <p>Final score: <span id="finalScoreText">0</span></p>
            <p>Normalized score: <span id="normalizedScoreText">0</span>/100</p>
            <p>Health star rating: <span id="healthStarRatingText">0</span></p>
            <p>Rating meaning: <span id="ratingMeaningText">None</span></p>
        </div>

        <div>
            <h2>About</h2>
            <div class="container">
                <div class="container-title">Credits</div>
                <p><strong>Made by</strong>: AaronMiscellaneous</p>
                <p>
                    <strong>Based off of</strong>:
                    <a href="https://www.healthstarrating.gov.au/" target="_blank">www.healthstarrating.gov.au</a>
                </p>
            </div>

            <div class="container">
                <div class="container-title">What is the Health Rating?</div>
                <p>The Health Star Rating (HSR) system rates the nutritional profile of packaged food. Used in Australia and New Zealand.</p>
                <p>The Health Rating used in this website is a modified version of the HSR system.</p>
                <p>Changes:</p>
                <ul>
                    <li>Interpolation. Instead of rounding to the nearest integer, it will interpolate between them. For example, 0g sodium will give 0 points and 90g will give 1 point. But 45g will give 0 points. With interpolation, it gives 0.5 points.</li>
                    <li>Normalized score. The normalized score is the final score normalized so 25 is 0 and -10 is 100, placing it on a scale.</li>
                </ul>
            </div>

            <div class="container">
                <div class="container-title">Results</div>
                <p><strong>Stars/Rating</strong>: The lowest if 0.5 and highest is 5. More stars means better nutritional value, compared to similar products.</p>
                <p><strong>Points</strong>: Baseline points are bad. Modifying points are good.</p>
                <p><strong>Final rating</strong>: The final rating is baseline points - modifying points. The lower the final rating, the better the nutritional value.</p>
                <ul>
                    <li>Low (healthy) = -10.</li>
                    <li>High (unhealthy) = 25.</li>
                </ul>
                <p><strong>Normalized rating</strong>: The normalized rating is the final rating normalized so 25 is 0 and -10 is 100, placing it on a scale. It can go above or below.</p>
            </div>

            <div class="container">
                <div class="container-title">Supported Foods</div>
                <p>This website only supports:</p>
                <ul>
                    <li>Non-dairy (not milk, butter, etc).</li>
                    <li>Foods (no drinks).</li>
                    <li>Basically most foods that are at a supermarket that are not a single "ingredient".</li>
                    <li>See HSR website for more details.</li>
                </ul>
            </div>
        </div>
    <script>
        const baselineNutrientConfig = {
            energy: {
                amount: () => getFloatFromId("energyInput"),
                method: "linear",
                gradient: 335,
                maxPoints: 11,
                outputId: "energyPoints"
            },
            saturatedFat: {
                amount: () => getFloatFromId("saturatedFatInput"),
                method: "list",
                list: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11.2, 12.5, 13.9, 15.5, 17.3, 19.3, 21.6, 24.1, 26.9, 30, 33.5, 37.4, 41.7, 46.6, 52, 58, 64.7, 72.3, 80.6, 90],
                outputId: "saturatedFatPoints",
                max: 100
            },
            sugar: {
                amount: () => getFloatFromId("sugarInput"),
                method: "linear",
                gradient: 3.808,
                maxPoints: 25,
                outputId: "sugarPoints",
                max: 100
            },
            sodium: {
                amount: () => getFloatFromId("sodiumInput"),
                method: "linear",
                gradient: 90,
                maxPoints: 30,
                outputId: "sodiumPoints",
                max: 100000
            },
        };

        const modifierNutrientConfig = {
            concentratedFnvl: {
                amount: () => getFloatFromId("concentratedFnvlInput"),
                method: "list",
                list: [0, 25, 43, 52, 63, 67, 80, 90, 99.5],
                outputId: "concentratedFnvlPoints",
                max: 100
            },
            nonConcentratedFnvl: {
                amount: () => getFloatFromId("nonConcentratedFnvlInput"),
                method: "list",
                list: [0, 40, 60, 67, 75, 80, 90, 95, 99.5],
                outputId: "nonConcentratedFnvlPoints",
                max: 100
            },
            protein: {
                amount: () => getFloatFromId("proteinInput"),
                method: "list",
                list: [0, 1.6, 3.2, 4.8, 6.4, 8, 9.6, 11.6, 13.9, 16.7, 20, 24, 28.9, 34.7, 41.6, 50],
                outputId: "proteinPoints",
                max: 100
            },
            dietaryFibre: {
                amount: () => getFloatFromId("dietaryFibreInput"),
                list: [0, .9, 1.9, 2.8, 3.7, 4.7, 5.4, 6.3, 7.3, 8.4, 9.7, 11.2, 13, 15, 17.3, 20],
                method: "list",
                outputId: "dietaryFibrePoints",
                max: 100
            },
        };

        const healthStarRatingList = [-10, -6, -1, 3, 7, 12, 16, 21, 25];

        let totalBaselinePoints = 0;
        let totalModifyingPoints = 0;

        let finalScore = 0;
        let normalizedScore = 0;
        let healthStarRating = 0;
        let ratingMeaning = "";

        function roundToPlace(value, place=2) {
            return Math.round(value * Math.pow(10, place)) / Math.pow(10, place);
        }

        function normalize(value, min, max, multiplier=1) {
            return (value - min) / (max - min) * multiplier;
        }

        function getFloatFromId(id) {
            /**
             * Returns the value of the input field with the given id as a float.
             * @param {string} id - The id of the element.
             * @returns {number} - The value of the element with that id.
             */
            const raw = document.getElementById(id).value;
            const num = parseFloat(raw);
            return isNaN(num) ? 0 : num;
        }

        function setMaxValueOfId(id, value, maximum) {
            /**
             * Sets the value of the input field with the given id to the minimum of the value and the maximum.
             * @param {string} id - The id of the element.
             * @param {number} value - The value of the element with that id.
             * @param {number} maximum - The maximum value of the element with that id.
             * @returns {void}
             */
            document.getElementById(id).value = Math.min(value, maximum);
        }

        function calculatePoints(singleNutrientConfig) {
            /**
             * Returns the number of points given the amount of the nutrient.
             * @param {object} singleNutrientConfig - The config for the nutrient.
             * @returns {number} - The number of points for the nutrient.
             */
            let amount = singleNutrientConfig.amount();
            if (singleNutrientConfig.method === "linear") {
                let points =  amount / singleNutrientConfig.gradient;
                points = Math.min(points, singleNutrientConfig.maxPoints);
                return points;
            }
            else if (singleNutrientConfig.method === "list") {
                let list = singleNutrientConfig.list;
                for (let i = list.length - 1; i >= 0; i--) {
                    if (amount > list[i]) {
                        if (!(i === list.length - 1)) {
                            small_value = list[i];
                            large_value = list[i + 1];
                            points = (amount - small_value) / (large_value - small_value) + i;
                            return points;
                        }
                        return i;
                    }
                }
                return 0; 
            }


        }
        
        function updatePoints(nutrientCollectionConfig) {
            let totalPoints = 0;

            for (const key in nutrientCollectionConfig) { // Loops through every nutrient
                const singleNutrientConfig = nutrientCollectionConfig[key]; // Gets the specific nutrient config

                let amount = singleNutrientConfig.amount(); // Gets the amount of the nutrient inputted

                if (singleNutrientConfig.max !== undefined) { // If the nutrient has a max
                    setMaxValueOfId(key + "Input", amount, singleNutrientConfig.max); // Sets the value of the input field to the minimum of the amount and the max
                    amount = Math.min(amount, singleNutrientConfig.max); // Sets the amount to the minimum of the amount and the max
                }

                let points = calculatePoints(singleNutrientConfig); // Calculates the points
                totalPoints += points;

                document.getElementById(singleNutrientConfig.outputId).innerHTML = roundToPlace(points); // Updates the output element to the points
            }
            return totalPoints;
        }

        function updateBaselinePoints() {
            totalBaselinePoints = updatePoints(baselineNutrientConfig);
            document.getElementById("totalBaselinePoints").innerHTML = roundToPlace(totalBaselinePoints);
        }

        function updateModifierPoints() {
            totalModifyingPoints = updatePoints(modifierNutrientConfig);
            document.getElementById("totalModifyingPoints").innerHTML = roundToPlace(totalModifyingPoints);
        }

        function calculateHealthStarRating() {
            for (let i = 0; i < healthStarRatingList.length; i++) { // Loops through the health star rating list
                if (roundToPlace(finalScore, 0) < healthStarRatingList[i]) { // If the final score is less than the current health star rating
                    let currentFinalScore = healthStarRatingList[i];
                    let currentHealthStarRating = 5 - .5 * i; // Calculates the current health star rating

                    currentHealthStarRating = Math.min(currentHealthStarRating, 5);
                    currentHealthStarRating = Math.max(currentHealthStarRating, 0.5);

                    return currentHealthStarRating;
                }
            }

            return 0.5;
        }

        function getRatingMeaning(healthStarRating) {
            if (healthStarRating <= 1) return "Very Poor";
            if (healthStarRating <= 2) return "Poor";
            if (healthStarRating <= 3) return "Average";
            if (healthStarRating <= 4) return "Good";
            if (healthStarRating <= 5) return "Excellent";
        }

        function calculateResults() {
            finalScore = totalBaselinePoints - totalModifyingPoints;
            normalizedScore = normalize(finalScore, 25, -10, 100);
            healthStarRating = calculateHealthStarRating();
            ratingMeaning = getRatingMeaning(healthStarRating);
        }

        function updateResults() {
            document.getElementById("finalScoreText").innerHTML = roundToPlace(finalScore);
            document.getElementById("normalizedScoreText").innerHTML = roundToPlace(normalizedScore, 0);
            document.getElementById("healthStarRatingText").innerHTML = healthStarRating;
            document.getElementById("ratingMeaningText").innerHTML = ratingMeaning;
        }


        function updateResultsVisual() {
            const box = document.getElementById("resultsBox");
            box.classList.remove(
                "rating-verypoor",
                "rating-poor",
                "rating-average",
                "rating-good",
                "rating-excellent"
            );

            if (healthStarRating <= 1) box.classList.add("rating-verypoor");
            else if (healthStarRating <= 2) box.classList.add("rating-poor");
            else if (healthStarRating <= 3) box.classList.add("rating-average");
            else if (healthStarRating <= 4) box.classList.add("rating-good");
            else box.classList.add("rating-excellent");
        }        
        
        function update() {
            updateBaselinePoints();
            updateModifierPoints();
            calculateResults();
            updateResults();
            updateResultsVisual();
        }

        window.onload = update;
    </script>
    </body>
</html>